## 前言

👀本文专注于webpack能做的性能优化~

性能优化也分环境，环境不同关注点也不同👇

- 开发环境性能优化：
  - 优化打包构建速度（以下简称构速）
  - 优化代码调试（以下简称调试）
- 生产环境性能优化：
  - 优化打包构建速度（以下简称构速）
  - 优化代码运行的性能（以下简称性能）

对照着代码看效果更佳哦，有错误的地方麻烦帮忙指出🙏🙏

## 开发环境性能优化

### 『构速』HMR (Hot Module Replacement 热模块替换/模块热替换)

#### 含义

一个模块发生变化，只会重新打包这一个模块（而不是打包所有模块或刷新整个标签页），极大地提高了打包构建速度。

#### 配置1：开启HMR - 只在*webpack配置文件-devServer*中添加：`hot: true`

**1）代码：**

这里只列出了部分代码（另外还有样式、html未列出），建议将完整代码下载下来看~

```js
// 文件位置：webpack.config.js
const { resolve } = require('path');
const HTMLWebpackPlugin = require('html-webpack-plugin');
// const webpack = require('webpack');

module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: 'style-loader',
          }, 
          {
            loader: 'css-loader',
          }
        ],
      },
      {
        test: /\.less$/,
        use: ['style-loader', 'css-loader', 'less-loader']
      },
      {
        test: /.(gif|png|jpg)$/,
        loader: 'url-loader',
        options: {
          limit: 8 * 1024,
          esModule: false,
          name: '[hash:8].[ext]',
          outputPath: 'images'
        }
      },
      {
        test: /\.html$/,
        loader: 'html-loader',
        options: {
          esModule: false,
        }
      },
      {
        exclude: /\.(html|css|less|gif|png|jpg|js)$/,
        loader: 'file-loader',
        options: {
          outputPath: 'icon',
          name: '[hash:8].[ext]',
        }
      }
    ]
  },
  plugins: [
    new HTMLWebpackPlugin({
      template: './src/index.html'
    }),
    // new webpack.HotModuleReplacementPlugin() // 官网上还加了这句
  ],
  mode: 'development',
  devServer: {
    open: true,
    port: 3000,
    contentBase: resolve(__dirname, 'build'),
    compress: true,
    // 开启HMR功能
    // 当修改了webpack配置，新配置要想生效，必须重启webpack服务
    hot: true
  }
}
```

```js
// 文件位置：src/js/index.js:
import '../styles/iconfont.css';
import '../styles/index.less';
import print from './print';

console.log('index.js文件被加载了~');

print();

function add(x, y) {
  return x + y;
}

console.log(add(1, 5));
```

```js
// 文件位置：src/js/print.js:
console.log('print.js被加载了~');

function print() {
  const content = 'hello print 2';
  console.log(content);
}

export default print;
```

**2）效果：**

- 修改样式文件：HMR**生效**（因为`style-loader`内部实现了HMR）；
- 修改html文件：HMR**不生效**，也**不自动刷新**标签页；
  - 注意：html默认不能使用HMR，也确实不用做HMR（因为浏览器一个tab页始终只能打开一个html页面，或者可以理解为单页应用只有一个html，也就是说打开的始终只有一个html模块）
  - 但是存在一个问题：修改这一个html里的代码，html文件不能更新了（除非手动刷新整个标签页）
  - 如何解决：看**配置2**
- js文件：HMR**不生效**，也**不自动刷新**标签页；

#### 配置2：解决html不自动刷新 - 修改*webpack配置文件-entry*

修改entry入口，将html文件引入（`entry: ['./src/js/index.js', './src/index.html']`）

**1）代码：**

这里只列出了需要修改的文件，建议将完整代码下载下来看~

```js
// 文件位置：webpack.config.js
const { resolve } = require('path');
const HTMLWebpackPlugin = require('html-webpack-plugin');
// const webpack = require('webpack');

module.exports = {
  // 加入“./src/index.html”：使html修改后可以自动刷新
  entry: ['./src/js/index.js', './src/index.html'],
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: 'style-loader',
          }, 
          {
            loader: 'css-loader',
          }
        ],
      },
      {
        test: /\.less$/,
        use: ['style-loader', 'css-loader', 'less-loader']
      },
      {
        test: /.(gif|png|jpg)$/,
        loader: 'url-loader',
        options: {
          limit: 8 * 1024,
          esModule: false,
          name: '[hash:8].[ext]',
          outputPath: 'images'
        }
      },
      {
        test: /\.html$/,
        loader: 'html-loader',
        options: {
          esModule: false,
        }
      },
      {
        exclude: /\.(html|css|less|gif|png|jpg|js)$/,
        loader: 'file-loader',
        options: {
          outputPath: 'icon',
          name: '[hash:8].[ext]',
        }
      }
    ]
  },
  plugins: [
    new HTMLWebpackPlugin({
      template: './src/index.html'
    }),
    // new webpack.HotModuleReplacementPlugin() // 官网上还加了这句
  ],
  mode: 'development',
  devServer: {
    open: true,
    port: 3000,
    contentBase: resolve(__dirname, 'build'),
    compress: true,
    // 开启HMR功能
    // 当修改了webpack配置，新配置要想生效，必须重启webpack服务
    hot: true
  }
}
```

**2）效果：**

- 修改样式文件：HMR生效（因为`style-loader`内部实现了HMR）；
- 修改html文件：HMR不生效，但会自动刷新整个标签页；
- js文件：HMR不生效，也不自动刷新标签页；

#### 配置3：解决JS的HMR不生效 - 入口文件中加配置

**1）代码：**

在入口文件“src/js/index.js”中添加以下代码，其他配置不变：

```js
if (module.hot) {
  // 一旦 module.hot 为true，说明开启了HMR功能。 --> 让HMR功能代码生效
  module.hot.accept('./print.js', function() {
    // 方法会监听 print.js 文件的变化，一旦发生变化，其他模块不会重新打包构建。
    // 会执行后面的回调函数
    print();
  });
}
```

**2）效果：**

- 修改样式文件：HMR生效（因为`style-loader`内部实现了HMR）；
- 修改html文件：HMR不生效，但会自动刷新整个标签页（html文件不需要HMR）；
- js文件：HMR生效（修改print.js，HMR生效；修改index.js，自动刷新整个标签页）；

#### HMR小结

开启HMR（webpack配置中添加`hot: true`）之后：

- 样式文件：HMR**生效**（`style-loader`内部实现了HMR，无需其他配置）；
- html文件：HMR**不生效**（也不需要生效），也**不自动刷新**标签页：
  - html不需要HMR：html默认不能使用HMR，也确实不用做HMR（因为浏览器一个tab页始终只能打开一个html页面，也可以理解为单页应用）。
  - 问题 - 标签页不自动刷新：
    - 如何解决：修改entry入口，将html文件引入（`entry: ['./src/js/index.js', './src/index.html']`）
- js文件：HMR**默认不生效**（有修改时会刷新整个标签页）。要使用需要修改js代码（添加支持HMR功能的代码）：
  - 注意：HMR功能对js的处理，只能处理非入口js文件；
  - 代码（在入口js中添加）：

    ```js
    if (module.hot) {
      // 一旦 module.hot 为true，说明开启了HMR功能。 --> 让HMR功能代码生效
      module.hot.accept('./print.js', function() {
        // 方法会监听 print.js 文件的变化，一旦发生变化，其他模块不会重新打包构建。
        // 会执行后面的回调函数
        print();
      });
    }
    ```

  - 效果：修改print.js，HMR生效；修改index.js，自动刷新整个标签页

### 『调试』source-map
