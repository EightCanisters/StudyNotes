## 1. 综述

关于什么是进程/线程，先来看个标准答案：**进程是资源分配的最小单位，线程是CPU调度的最小单位**。  

## 2. 背景：从CPU开始

我们用的电脑由CPU+RAM+各种资源（比如显卡，光驱，键盘，GPS, 等等外设）构成。但是电脑的运行，主要就是CPU、相关寄存器和RAM之间的事情。其中CPU又是重中之重，它承担了所有的计算任务。

### 2.1. 事实1：CPU速度太快以至于像多个任务在同步执行

CPU的计算速度是非常迅速的，使得寄存器、RAM和别的设备资源等一直在追赶CPU的脚步（还经常追不上）。  
那么当有多个任务要计算（或者说执行）时，就轮流着来，尽量占据CPU的时间，尽力压榨它。  
所以我们把时间拉长一点看，这些任务就仿佛是在同时运行==

### 2.2. 事实2：任务在准备好后才会被调度给CPU执行

为了更好的压榨CPU，在执行任务（程序代码）之前（其实执行的应该是指令，大家理解意思就行），就必须把相关的资源都准备到位，做到万事俱备只欠CPU。  
所以就有了就绪队列，将准备好的任务都放到就绪队列中。  
然后由操作系统的调度算法，选出待执行的任务让CPU执行。

### 2.3. 引入概念：进程的上下文环境

这里引入一个概念：除了CPU外所有的执行环境（主要是寄存器的一些内容），就构成了进程的上下文环境。进程的上下文就是进程执行的环境。  
当程序A执行完了，或者分配给程序A的CPU时间用完了，那它就会被切换出去，等待下一次被CPU临幸。  
在切换出去时，还需要保存程序上下文，因为这就是下次CPU临幸时的运行环境。

### 2.4. 小结

在CPU看来所有的任务（任务其实就是进程）都是一个一个的轮流执行的，具体的轮流方法就是：先加载进程A的上下文，然后开始执行A，保存进程A的上下文，调入下一个要执行的进程B的进程上下文，然后开始执行B,保存进程B的上下文……

## 3. 什么是进程

进程就是上下文切换之间的程序执行的部分。它是运行中的程序的描述，是对应于该段CPU执行时间的描述，是**操作系统进行资源分配和调度的一个独立单位**，是应用程序运行的载体。

它一般由程序、数据集合和进程控制块三部分组成（也就是上下文）：

- 程序：用于描述进程要完成的功能，是控制进程执行的指令集；
- 数据集合：是程序在执行时所需要的数据和工作区；
- 程序控制块(Program Control Block，简称PCB)：包含进程的描述信息和控制信息，是进程存在的唯一标志。

## 4. 什么是线程

进程还是太大了，主要是每次执行都要进行进程的上下文切换。  
我们把进程看作一个运行在电脑上的软件，但软件的执行是不可能一条逻辑执行到底的，必定有许多个分支和程序段。

比如现有程序A，它又由a、b、c等多个块组合而成，那么这里具体的执行就可能变成：

```
程序A得到CPU --> CPU加载上下文 --> CPU开始执行程序A的a小段 
--> 然后执行A的b小段 --> 然后再执行A的c小段 --> 最后CPU保存A的上下文，切换写一个程序
```

上边的a, b, c的执行共享了A进程的上下文，CPU再执行的时候仅仅切换a, b, c的上下文，而没有进行进程A上下文的切换，这就让CPU的使用效率进一步提高。  
其实，上边的a, b, c就是线程，也就是说：

- 线程共享了进程的上下文环境，它是依附于进程的；
- 从CPU执行时间上看，线程是更为细小的CPU时间段；
- 在进程中使用多线程并行处理能提升运算效率，进程将任务分成很多细小的任务，再创建多个线程，在里面并行分别执行。

## 5. 总结：进程&线程，及它们的关系

- 进程：
  - 进程代表CPU能处理的单个任务，它有着系统分配的独立的一块内存；
  - 任一时刻，CPU总是运行一个进程，而其他进程处于非运行状态；
- 进程间：
  - 进程与进程之间相互独立，一个进程的崩溃不会影响到其他进程，但也意味着不同进程间数据很难共享；
  - 进程间需要传递某些数据的话，需要通过特殊的管道（进程通信管道IPC）来转递，这里不再赘述。
- 进程与线程：
  - 一个进程由一个或多个线程组成，每个线程并行执行不同的任务；
  - 一个进程中的任意一个线程执行出错，将导致这个进程崩溃；
- 线程间：
  - 同一个进程下的线程之间可以直接通信和共享数据；
  - 同一个进程下的各个线程之间共享进程的内存空间：
    - 互斥锁：使用互斥锁，防止多个线程同时读写某一块内存区域。一个线程使用某些共享内存时，其他线程必须等它结束后，才能使用这一块内存；
    - 信号量：使用信号量，来保证多个线程不会互相冲突。将进程使用的内存地址限定使用量。
- 当一个进程关闭后，操作系统会回收该进程的内存空间。

## 6. 参考

- [线程和进程的区别是什么？](https://www.zhihu.com/question/25532384)
- [阮一峰-进程与线程的一个简单解释](https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)
- [深入理解浏览器中的进程与线程](https://juejin.cn/post/6991849728493256741)
- [聊聊进程和线程](https://juejin.cn/post/6953601354002595871)
- [写给大忙人看的进程和线程](https://juejin.cn/post/6844904080393912327)
- [工作2年，有些人竟然还不懂进程、线程、协程之间的关系！](https://juejin.cn/post/6904821235801128967)
