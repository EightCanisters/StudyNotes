## å‰è¨€

ğŸ‘€æœ¬æ–‡ä¸“æ³¨äºwebpackèƒ½åšçš„æ€§èƒ½ä¼˜åŒ–~

æ€§èƒ½ä¼˜åŒ–ä¹Ÿåˆ†ç¯å¢ƒï¼Œç¯å¢ƒä¸åŒå…³æ³¨ç‚¹ä¹Ÿä¸åŒğŸ‘‡

- å¼€å‘ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–ï¼š
  - ä¼˜åŒ–æ‰“åŒ…æ„å»ºé€Ÿåº¦ï¼ˆä»¥ä¸‹ç®€ç§°æ„é€Ÿï¼‰
  - ä¼˜åŒ–ä»£ç è°ƒè¯•ï¼ˆä»¥ä¸‹ç®€ç§°è°ƒè¯•ï¼‰
- ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–ï¼š
  - ä¼˜åŒ–æ‰“åŒ…æ„å»ºé€Ÿåº¦ï¼ˆä»¥ä¸‹ç®€ç§°æ„é€Ÿï¼‰
  - ä¼˜åŒ–ä»£ç è¿è¡Œçš„æ€§èƒ½ï¼ˆä»¥ä¸‹ç®€ç§°æ€§èƒ½ï¼‰

ä»ç¯‡å¹…è€ƒè™‘ï¼Œåªåˆ—ä¸¾å¿…è¦ä»£ç ã€‚å…·ä½“è¯·çœ‹[è¿™é‡Œ](https://github.com/FE-Huang/StudyNotes/tree/master/6.%20FE%E5%B7%A5%E5%85%B7/Webpack/%E4%BB%A3%E7%A0%81/4.webpack%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96)ã€‚å¯¹ç…§ç€çœ‹æ•ˆæœæ›´ä½³å“¦ï¼Œæœ‰é”™è¯¯çš„åœ°æ–¹éº»çƒ¦å¸®å¿™æŒ‡å‡ºğŸ™ğŸ™

## ã€æ„é€Ÿã€HMR (Hot Module Replacement çƒ­æ¨¡å—æ›¿æ¢/æ¨¡å—çƒ­æ›¿æ¢)

### ç®€ä»‹

ä¸€ä¸ªæ¨¡å—å‘ç”Ÿå˜åŒ–ï¼Œåªä¼šé‡æ–°æ‰“åŒ…è¿™ä¸€ä¸ªæ¨¡å—ï¼ˆè€Œä¸æ˜¯æ‰“åŒ…æ‰€æœ‰æ¨¡å—æˆ–åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼‰ï¼Œæå¤§åœ°æé«˜äº†æ‰“åŒ…æ„å»ºé€Ÿåº¦ã€‚

**æ³¨æ„ï¼š**

- å› ä¸ºHMRæ˜¯åŸºäºdevServerçš„ï¼Œæ‰€ä»¥å®ƒåªèƒ½ç”¨äºå¼€å‘ç¯å¢ƒï¼›
- éœ€è¦å°†package.jsonä¸­çš„browserslistæ³¨é‡Š/åˆ æ‰ã€‚

### é…ç½®1ï¼šå¼€å¯HMR

åªåœ¨*webpacké…ç½®æ–‡ä»¶-devServer*ä¸­æ·»åŠ ï¼š`hot: true`ï¼š

```js
module.exports = {
  devServer: {
    hor: true
  }
}
```

#### ä»£ç 

è¿™é‡Œåªåˆ—å‡ºäº†éƒ¨åˆ†ä»£ç ï¼ˆå¦å¤–è¿˜æœ‰æ ·å¼ã€htmlæœªåˆ—å‡ºï¼‰ï¼Œå»ºè®®å°†å®Œæ•´ä»£ç ä¸‹è½½ä¸‹æ¥çœ‹~

```js
// æ–‡ä»¶ä½ç½®ï¼šwebpack.config.js
const { resolve } = require('path');
const HTMLWebpackPlugin = require('html-webpack-plugin');
// const webpack = require('webpack');

module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: 'style-loader',
          }, 
          {
            loader: 'css-loader',
          }
        ],
      },
      {
        test: /\.less$/,
        use: ['style-loader', 'css-loader', 'less-loader']
      },
      {
        test: /.(gif|png|jpg)$/,
        loader: 'url-loader',
        options: {
          limit: 8 * 1024,
          esModule: false,
          name: '[hash:8].[ext]',
          outputPath: 'images'
        }
      },
      {
        test: /\.html$/,
        loader: 'html-loader',
        options: {
          esModule: false,
        }
      },
      {
        exclude: /\.(html|css|less|gif|png|jpg|js)$/,
        loader: 'file-loader',
        options: {
          outputPath: 'icon',
          name: '[hash:8].[ext]',
        }
      }
    ]
  },
  plugins: [
    new HTMLWebpackPlugin({
      template: './src/index.html'
    }),
    // new webpack.HotModuleReplacementPlugin() // å®˜ç½‘ä¸Šè¿˜åŠ äº†è¿™å¥
  ],
  mode: 'development',
  devServer: {
    open: true,
    port: 3000,
    contentBase: resolve(__dirname, 'build'),
    compress: true,
    // å¼€å¯HMRåŠŸèƒ½
    // å½“ä¿®æ”¹äº†webpacké…ç½®ï¼Œæ–°é…ç½®è¦æƒ³ç”Ÿæ•ˆï¼Œå¿…é¡»é‡å¯webpackæœåŠ¡
    hot: true
  }
}
```

```js
// æ–‡ä»¶ä½ç½®ï¼šsrc/js/index.js:
import '../styles/iconfont.css';
import '../styles/index.less';
import print from './print';

console.log('index.jsæ–‡ä»¶è¢«åŠ è½½äº†~');

print();

function add(x, y) {
  return x + y;
}

console.log(add(1, 5));
```

```js
// æ–‡ä»¶ä½ç½®ï¼šsrc/js/print.js:
console.log('print.jsè¢«åŠ è½½äº†~');

function print() {
  const content = 'hello print 2';
  console.log(content);
}

export default print;
```

#### æ•ˆæœ

- ä¿®æ”¹æ ·å¼æ–‡ä»¶ï¼šHMR**ç”Ÿæ•ˆ**ï¼ˆå› ä¸º`style-loader`å†…éƒ¨å®ç°äº†HMRï¼‰ï¼›
- ä¿®æ”¹htmlæ–‡ä»¶ï¼šHMR**ä¸ç”Ÿæ•ˆ**ï¼Œä¹Ÿ**ä¸è‡ªåŠ¨åˆ·æ–°**æ ‡ç­¾é¡µï¼›
  - æ³¨æ„ï¼šhtmlé»˜è®¤ä¸èƒ½ä½¿ç”¨HMRï¼Œä¹Ÿç¡®å®ä¸ç”¨åšHMRï¼ˆå› ä¸ºæµè§ˆå™¨ä¸€ä¸ªtabé¡µå§‹ç»ˆåªèƒ½æ‰“å¼€ä¸€ä¸ªhtmlé¡µé¢ï¼Œæˆ–è€…å¯ä»¥ç†è§£ä¸ºå•é¡µåº”ç”¨åªæœ‰ä¸€ä¸ªhtmlï¼Œä¹Ÿå°±æ˜¯è¯´æ‰“å¼€çš„å§‹ç»ˆåªæœ‰ä¸€ä¸ªhtmlæ¨¡å—ï¼‰
  - ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šä¿®æ”¹è¿™ä¸€ä¸ªhtmlé‡Œçš„ä»£ç ï¼Œhtmlæ–‡ä»¶ä¸èƒ½æ›´æ–°äº†ï¼ˆé™¤éæ‰‹åŠ¨åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼‰
  - å¦‚ä½•è§£å†³ï¼šçœ‹**é…ç½®2**
- jsæ–‡ä»¶ï¼šHMR**ä¸ç”Ÿæ•ˆ**ï¼Œä¹Ÿ**ä¸è‡ªåŠ¨åˆ·æ–°**æ ‡ç­¾é¡µï¼›

### é…ç½®2ï¼šè§£å†³htmlä¸è‡ªåŠ¨åˆ·æ–°

ä¿®æ”¹webpacké…ç½®çš„entry(å…¥å£)ï¼Œå°†htmlæ–‡ä»¶å¼•å…¥ï¼š

```js
module.exports = {
  entry: ['./src/js/index.js', './src/index.html']
}
```

#### ä»£ç 

è¿™é‡Œåªåˆ—å‡ºäº†éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼Œå»ºè®®å°†å®Œæ•´ä»£ç ä¸‹è½½ä¸‹æ¥çœ‹~

```js
// æ–‡ä»¶ä½ç½®ï¼šwebpack.config.js
const { resolve } = require('path');
const HTMLWebpackPlugin = require('html-webpack-plugin');
// const webpack = require('webpack');

module.exports = {
  // åŠ å…¥â€œ./src/index.htmlâ€ï¼šä½¿htmlä¿®æ”¹åå¯ä»¥è‡ªåŠ¨åˆ·æ–°
  entry: ['./src/js/index.js', './src/index.html'],
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: 'style-loader',
          }, 
          {
            loader: 'css-loader',
          }
        ],
      },
      {
        test: /\.less$/,
        use: ['style-loader', 'css-loader', 'less-loader']
      },
      {
        test: /.(gif|png|jpg)$/,
        loader: 'url-loader',
        options: {
          limit: 8 * 1024,
          esModule: false,
          name: '[hash:8].[ext]',
          outputPath: 'images'
        }
      },
      {
        test: /\.html$/,
        loader: 'html-loader',
        options: {
          esModule: false,
        }
      },
      {
        exclude: /\.(html|css|less|gif|png|jpg|js)$/,
        loader: 'file-loader',
        options: {
          outputPath: 'icon',
          name: '[hash:8].[ext]',
        }
      }
    ]
  },
  plugins: [
    new HTMLWebpackPlugin({
      template: './src/index.html'
    }),
    // new webpack.HotModuleReplacementPlugin() // å®˜ç½‘ä¸Šè¿˜åŠ äº†è¿™å¥
  ],
  mode: 'development',
  devServer: {
    open: true,
    port: 3000,
    contentBase: resolve(__dirname, 'build'),
    compress: true,
    // å¼€å¯HMRåŠŸèƒ½
    // å½“ä¿®æ”¹äº†webpacké…ç½®ï¼Œæ–°é…ç½®è¦æƒ³ç”Ÿæ•ˆï¼Œå¿…é¡»é‡å¯webpackæœåŠ¡
    hot: true
  }
}
```

#### æ•ˆæœ

- ä¿®æ”¹æ ·å¼æ–‡ä»¶ï¼šHMRç”Ÿæ•ˆï¼ˆå› ä¸º`style-loader`å†…éƒ¨å®ç°äº†HMRï¼‰ï¼›
- ä¿®æ”¹htmlæ–‡ä»¶ï¼šHMRä¸ç”Ÿæ•ˆï¼Œä½†ä¼šè‡ªåŠ¨åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼›
- jsæ–‡ä»¶ï¼šHMRä¸ç”Ÿæ•ˆï¼Œä¹Ÿä¸è‡ªåŠ¨åˆ·æ–°æ ‡ç­¾é¡µï¼›

### é…ç½®3ï¼šè§£å†³JSçš„HMRä¸ç”Ÿæ•ˆ

éœ€åœ¨å…¥å£æ–‡ä»¶ä¸­åŠ é…ç½®ï¼ˆè§ä»£ç ï¼‰ã€‚

#### ä»£ç 

åœ¨å…¥å£æ–‡ä»¶â€œsrc/js/index.jsâ€ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œå…¶ä»–é…ç½®ä¸å˜ï¼š

```js
if (module.hot) {
  // ä¸€æ—¦ module.hot ä¸ºtrueï¼Œè¯´æ˜å¼€å¯äº†HMRåŠŸèƒ½ã€‚ --> è®©HMRåŠŸèƒ½ä»£ç ç”Ÿæ•ˆ
  module.hot.accept('./print.js', function() {
    // æ–¹æ³•ä¼šç›‘å¬ print.js æ–‡ä»¶çš„å˜åŒ–ï¼Œä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œå…¶ä»–æ¨¡å—ä¸ä¼šé‡æ–°æ‰“åŒ…æ„å»ºã€‚
    // ä¼šæ‰§è¡Œåé¢çš„å›è°ƒå‡½æ•°
    print();
  });
}
```

#### æ•ˆæœ

- ä¿®æ”¹æ ·å¼æ–‡ä»¶ï¼šHMRç”Ÿæ•ˆï¼ˆå› ä¸º`style-loader`å†…éƒ¨å®ç°äº†HMRï¼‰ï¼›
- ä¿®æ”¹htmlæ–‡ä»¶ï¼šHMRä¸ç”Ÿæ•ˆï¼Œä½†ä¼šè‡ªåŠ¨åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼ˆhtmlæ–‡ä»¶ä¸éœ€è¦HMRï¼‰ï¼›
- jsæ–‡ä»¶ï¼šHMRç”Ÿæ•ˆï¼ˆä¿®æ”¹print.jsï¼ŒHMRç”Ÿæ•ˆï¼›ä¿®æ”¹index.jsï¼Œè‡ªåŠ¨åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼‰ï¼›

### HMRå°ç»“

å¼€å¯HMRï¼ˆwebpacké…ç½®ä¸­æ·»åŠ `hot: true`ï¼‰ä¹‹åï¼š

- æ ·å¼æ–‡ä»¶ï¼šHMR**ç”Ÿæ•ˆ**ï¼ˆ`style-loader`å†…éƒ¨å®ç°äº†HMRï¼Œæ— éœ€å…¶ä»–é…ç½®ï¼‰ï¼›
- htmlæ–‡ä»¶ï¼šHMR**ä¸ç”Ÿæ•ˆ**ï¼ˆä¹Ÿä¸éœ€è¦ç”Ÿæ•ˆï¼‰ï¼Œä¹Ÿ**ä¸è‡ªåŠ¨åˆ·æ–°**æ ‡ç­¾é¡µï¼š
  - htmlä¸éœ€è¦HMRï¼šhtmlé»˜è®¤ä¸èƒ½ä½¿ç”¨HMRï¼Œä¹Ÿç¡®å®ä¸ç”¨åšHMRï¼ˆå› ä¸ºæµè§ˆå™¨ä¸€ä¸ªtabé¡µå§‹ç»ˆåªèƒ½æ‰“å¼€ä¸€ä¸ªhtmlé¡µé¢ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå•é¡µåº”ç”¨ï¼‰ã€‚
  - é—®é¢˜ - æ ‡ç­¾é¡µä¸è‡ªåŠ¨åˆ·æ–°ï¼š
    - å¦‚ä½•è§£å†³ï¼šä¿®æ”¹entryå…¥å£ï¼Œå°†htmlæ–‡ä»¶å¼•å…¥ï¼ˆ`entry: ['./src/js/index.js', './src/index.html']`ï¼‰
- jsæ–‡ä»¶ï¼šHMR**é»˜è®¤ä¸ç”Ÿæ•ˆ**ï¼ˆæœ‰ä¿®æ”¹æ—¶ä¼šåˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µï¼‰ã€‚è¦ä½¿ç”¨éœ€è¦ä¿®æ”¹jsä»£ç ï¼ˆæ·»åŠ æ”¯æŒHMRåŠŸèƒ½çš„ä»£ç ï¼‰ï¼š
  - æ³¨æ„ï¼šHMRåŠŸèƒ½å¯¹jsçš„å¤„ç†ï¼Œåªèƒ½å¤„ç†éå…¥å£jsæ–‡ä»¶ï¼›
  - ä»£ç ï¼ˆåœ¨å…¥å£jsä¸­æ·»åŠ ï¼‰ï¼š

    ```js
    if (module.hot) {
      // ä¸€æ—¦ module.hot ä¸ºtrueï¼Œè¯´æ˜å¼€å¯äº†HMRåŠŸèƒ½ã€‚ --> è®©HMRåŠŸèƒ½ä»£ç ç”Ÿæ•ˆ
      module.hot.accept('./print.js', function() {
        // æ–¹æ³•ä¼šç›‘å¬ print.js æ–‡ä»¶çš„å˜åŒ–ï¼Œä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œå…¶ä»–æ¨¡å—ä¸ä¼šé‡æ–°æ‰“åŒ…æ„å»ºã€‚
        // ä¼šæ‰§è¡Œåé¢çš„å›è°ƒå‡½æ•°
        print();
      });
    }
    ```

  - æ•ˆæœï¼šä¿®æ”¹print.jsï¼ŒHMRç”Ÿæ•ˆï¼›ä¿®æ”¹index.jsï¼Œè‡ªåŠ¨åˆ·æ–°æ•´ä¸ªæ ‡ç­¾é¡µ

## ã€è°ƒè¯•ã€source-map

### ç®€ä»‹

æ˜¯â€œæºä»£ç åˆ°æ„å»ºåä»£ç â€çš„**æ˜ å°„**ã€‚å¦‚æœæ„å»ºåä»£ç æŠ¥é”™ï¼Œå¯ä»¥é€šè¿‡æ˜ å°„å…³ç³»è¿½è¸ªæºä»£ç ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸­ä¹Ÿä¼šæŒ‡å‡º**æŠ¥é”™åŸå› **ã€**æºä»£ç çš„å…·ä½“ä½ç½®ï¼ˆæŸæ–‡ä»¶çš„æŸè¡ŒæŸåˆ—ï¼‰**ã€‚

![](https://gitee.com/ahuang6027/blog-images/raw/master/images/source-map-æŠ¥é”™ä¿¡æ¯.png)

ğŸ¤”å¯ä»¥çœ‹å‡ºï¼Œsource-mapæœ‰ä¸‰ä¸ªè¦ç‚¹ï¼š**æ˜ å°„å…³ç³»**ã€**æŠ¥é”™åŸå› **ã€**å…·ä½“ä½ç½®ï¼ˆæŸæ–‡ä»¶çš„æŸè¡ŒæŸåˆ—ï¼‰**ã€‚

### é…ç½®

```js
module.exports = {
  devtool: 'evel-source-map'
}
```

### ç±»å‹

æ ¹æ®ä¸¤ä¸ªè¦ç‚¹åå‘çš„ä¸åŒï¼Œsource-mapå…¶å®æœ‰ä¸åŒçš„ç±»å‹ğŸ‘‡

`[inline-|hidden-|eval-][nosources-][cheap-[module-]]source-map`

#### æ˜ å°„å…³ç³»

è¿™ç§æ˜ å°„å…³ç³»ä¸€èˆ¬æœ‰ä¸‰ç§å­˜æ”¾ä½ç½®ï¼š

- å½“å‰æ–‡ä»¶æœ«å°¾ï¼ˆæˆ‘æŠŠå®ƒç§°ä¸ºâ€œå†…è”â€ï¼‰ï¼›
- å½“å‰æ–‡ä»¶å†…æ¯å—ä»£ç æœ«å°¾ï¼ˆæˆ‘ç§°ä¸ºâ€œè¡Œå†…â€ï¼‰ï¼›
- å•ç‹¬çš„æ–‡ä»¶ï¼ˆæˆ‘ç§°ä¸ºâ€œå¤–éƒ¨â€ï¼‰ã€‚

#### ä¸åŒçš„source-mapâœ”ï¸âŒ

| ç±»å‹ | æ˜ å°„å…³ç³» | æŠ¥é”™åŸå›  | å¯è¿½è¸ªæºä»£ç  | å…·ä½“æ–‡ä»¶ | å…·ä½“è¡Œ | å…·ä½“åˆ— | æè¿° |
| :-----: | :---: | :--: | :--: | :--: | :--: | :--: | :--: |
| source-map | å¤–éƒ¨ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | é”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ã€å¯è¿½è¸ªæºä»£ç çš„é”™è¯¯ä½ç½® |
| inline-source-map | å†…è” | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | é”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ã€å¯è¿½è¸ªæºä»£ç çš„é”™è¯¯ä½ç½® |
| hidden-source-map | å¤–éƒ¨ | âœ”ï¸ | âŒ | âœ”ï¸ | âŒ | âŒ | æ§åˆ¶å°åªæç¤ºæºä»£ç çš„é”™è¯¯ä½ç½®ï¼Œä¸èƒ½è¿½è¸ªæºä»£ç é”™è¯¯ï¼ˆç‚¹è¿›å»æ˜¯æ‰“åŒ…åçš„æ–‡ä»¶ï¼‰ |
| eval-source-map | è¡Œå†… | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | é”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ã€å¯è¿½è¸ªæºä»£ç çš„é”™è¯¯ä½ç½® |
| nosources-source-map | å¤–éƒ¨ | âœ”ï¸ | âŒ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | æ§åˆ¶å°çš„æŠ¥é”™ä¿¡æ¯å†™äº†å…·ä½“æ–‡ä»¶ã€è¡Œã€åˆ—ï¼Œä½†ç‚¹è¿›å»æ‰¾ä¸åˆ°å¯¹åº”æ–‡ä»¶ |
| cheap-source-map | å¤–éƒ¨ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âŒ | é”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ã€å¯è¿½è¸ªæºä»£ç çš„é”™è¯¯ä½ç½® |
| cheap-module-source-map | å¤–éƒ¨ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âŒ | â€œmoduleâ€ä¼šå°†loaderçš„source mapåŠ å…¥ï¼ˆæ‰€ä»¥è°ƒè¯•æ›´å‹å¥½ï¼‰ |

#### å¼€å‘/ç”Ÿäº§æœ€ä¼˜è§£

- å¼€å‘ï¼šæ„å»ºé€Ÿåº¦å¿«ã€è°ƒè¯•æ›´å‹å¥½
  - æ„å»ºé€Ÿåº¦ï¼ˆå¿« --> æ…¢ï¼ševal > inline > cheap > ...ï¼‰ï¼š
    - eval-cheap-source-mapï¼ˆæœ€å¿«ï¼‰
    - eval-source-mapï¼ˆç¬¬äºŒå—ï¼‰
  - è°ƒè¯•å‹å¥½ï¼š
    - source-mapï¼ˆæœ€å‹å¥½ï¼‰
    - cheap-module-source-mapï¼ˆç¬¬äºŒï¼‰
    - cheap-source-mapï¼ˆç¬¬ä¸‰ï¼‰
  - ã€å°ç»“ã€‘å¼€å‘ç¯å¢ƒæœ€ä¼˜é€‰ï¼š
    - eval-source-mapï¼ˆå…¼é¡¾æ„å»ºé€Ÿåº¦å’Œè°ƒè¯•ï¼Œä½†åè°ƒè¯•ï¼‰
    - æˆ–eval-cheap-module-souce-mapï¼ˆå…¼é¡¾æ„å»ºé€Ÿåº¦å’Œè°ƒè¯•ï¼Œä½†åæ„å»ºï¼‰
- ç”Ÿäº§ï¼šæ˜¯å¦éšè—æºä»£ç ã€æ˜¯å¦éœ€è¦è°ƒè¯•å‹å¥½
  - éšè—æºä»£ç 
    - nosources-source-mapï¼šå…¨éƒ¨éšè—;
    - hidden-source-mapï¼šåªéšè—æºä»£ç ï¼Œä¼šæç¤ºæ„å»ºåä»£ç é”™è¯¯ä¿¡æ¯ã€‚
  - è°ƒè¯•æ›´å‹å¥½ï¼š
    - source-map
    - cheap-module-souce-map
  - ã€æ³¨æ„ã€‘å†…è”ä¼šè®©ä»£ç ä½“ç§¯å˜å¤§ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸ç”¨å†…è”

## ã€æ„é€Ÿã€oneOf

### ç®€ä»‹

é…ç½®åï¼š
ä¸€ä¸ªæ–‡ä»¶åœ¨æ„å»ºæ—¶ï¼Œä¼šåŒ¹é…oneOfæ•°ç»„é‡Œå¤´æŸä¸€ä¸ªloaderï¼Œç”¨äºä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…æ„å»ºé€Ÿåº¦ã€‚  
ï¼ˆä¸é…ç½®çš„è¯ï¼Œä¸€ä¸ªæ–‡ä»¶ä¼šæŒ¨ä¸ªå»åŒ¹é…loaderã€‚åŒ¹é…åˆ°ä¸€ä¸ªåä¹Ÿä¸ä¼šåœæ­¢ï¼Œå› ä¸ºä¸ç¡®å®šæ˜¯å¦æœ‰å¤šä¸ªloaderå‘½ä¸­ï¼‰

**æ³¨æ„ï¼š**oneOfæ•°ç»„é‡Œä¸èƒ½æœ‰ä¸¤ä¸ªloaderé…ç½®å¤„ç†åŒä¸€ç±»å‹çš„æ–‡ä»¶ã€‚å¦‚æœä¸€ä¸ªç±»å‹æœ‰å¤šä¸ªloaderï¼Œå¯åœ¨oneOfä¸­ä¿ç•™ä¸€ä¸ªï¼Œå°†å…¶ä½™çš„æåˆ°å¤–å±‚ã€‚

### é…ç½®

```js
const { resolve } = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

process.env.NODE_ENV = 'production';

const commonCssLoader = [
  MiniCssExtractPlugin.loader,
  'css-loader',
  {
    loader: 'postcss-loader',
    options: {}
  }
];

module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        enforce: 'pre', // ä¼˜å…ˆæ‰§è¡Œ
        loader: 'eslint-loader',
        options: {}
      },
      {
        // ä»¥ä¸‹loaderåªä¼šåŒ¹é…ä¸€ä¸ª
        // æ³¨æ„ï¼šä¸èƒ½æœ‰ä¸¤ä¸ªé…ç½®å¤„ç†åŒä¸€ç§ç±»å‹æ–‡ä»¶
        oneOf: [
          {
            test: /\.css$/,
            use: [...commonCssLoader]
          },
          {
            test: /\.less$/,
            use: [ ...commonCssLoader, 'less-loader' ]
          },
          {
            test: /\.js$/,
            exclude: /node_modules/,
            loader: 'babel-loader',
            options: {}
          },
          {
            test: /\.(jpg|png|gif)$/,
            loader: 'url-loader',
            options: {}
          },
          {
            test: /\.html$/,
            loader: 'html-loader',
            options: {}
          },
          {
            exclude: /\.(js|html|css|less|jpg|png|gif)$/,
            loader: 'file-loader',
            options: {}
          }
        ]
      }
    ]
  },
  plugins: [],
  mode: 'production'
}
```

## ç¼“å­˜

### ç®€ä»‹

ä»æ„å»ºé€Ÿåº¦å’Œéƒ¨ç½²è¿è¡Œä¸¤ä¸ªæ–¹é¢è€ƒè™‘ï¼š

- webpackæ‰“åŒ…æ„å»ºæ—¶ï¼Œåˆ©ç”¨ç¼“å­˜ä½¿é€Ÿåº¦å˜å¿«ï¼ˆbabelç¼“å­˜ï¼‰ï¼›
- é¡¹ç›®éƒ¨ç½²è¿è¡Œæ—¶ï¼Œåˆ©ç”¨æµè§ˆå™¨ç¼“å­˜ä½¿ç½‘é¡µåŠ è½½æ›´å¿«ã€‚webpackæ‰“åŒ…æ—¶ï¼Œåœ¨è¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åæœ«å°¾åŠ ä¸Šhashå€¼ï¼Œè§£å†³ç¼“å­˜é€ æˆçš„ä»£ç å¯èƒ½ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼ˆæ–‡ä»¶èµ„æºç¼“å­˜ï¼‰ã€‚

### ã€æ„é€Ÿã€Babelç¼“å­˜

#### é…ç½®

  ä¿®æ”¹`babel-loader`çš„é…ç½®ï¼Œæ·»åŠ `cacheDirectory: true`

  ```js
  module.exports = {
    module: {
      rules: [
        {
          test: /\.js$/,
          exclude: /node_modules/,
          loader: 'babel-loader',
          options: {
            presets: [],
            // å¼€å¯babelç¼“å­˜
            // ç¬¬äºŒæ¬¡æ„å»ºæ—¶ï¼Œä¼šè¯»å–ä¹‹å‰çš„ç¼“å­˜
            cacheDirectory: true
          }
        }
      ]
    }
  }
  ```

#### ä½œç”¨

ç¬¬äºŒæ¬¡æ„å»ºæ—¶ï¼Œä¼šè¯»å–ä¹‹å‰çš„ç¼“å­˜ï¼Œä»è€Œä½¿ç¬¬äºŒæ¬¡æ‰“åŒ…æ„å»ºé€Ÿåº¦æ›´å¿«ã€‚

### ã€æ€§èƒ½ã€æ–‡ä»¶èµ„æºç¼“å­˜

#### é…ç½®

åœ¨æ‰€æœ‰å¯ä»¥ç»™è¾“å‡ºæ–‡ä»¶å‘½åçš„åœ°æ–¹åŠ ä¸Š`[hash/contenthash/chunkhash:10]`ï¼ˆæ¯”å¦‚ï¼šå°†output.filenameä¿®æ”¹ä¸º`js/built.[hash:10].js`ï¼‰

```js
const { resolve } = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

process.env.NODE_ENV = 'production';

module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.[contenthash:10].js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      {
        // ä»¥ä¸‹loaderåªä¼šåŒ¹é…ä¸€ä¸ª
        // æ³¨æ„ï¼šä¸èƒ½æœ‰ä¸¤ä¸ªé…ç½®å¤„ç†åŒä¸€ç§ç±»å‹æ–‡ä»¶
        oneOf: [
          {
            test: /\.js$/,
            exclude: /node_modules/,
            loader: 'babel-loader',
            options: {
              presets: [],
              // å¼€å¯babelç¼“å­˜
              // ç¬¬äºŒæ¬¡æ„å»ºæ—¶ï¼Œä¼šè¯»å–ä¹‹å‰çš„ç¼“å­˜
              cacheDirectory: true
            }
          },
          {
            test: /\.(jpg|png|gif)$/,
            loader: 'url-loader',
            options: {
              limit: 8 * 1024,
              name: '[contenthash:10].[ext]',
              outputPath: 'images',
              esModule: false
            }
          },]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: 'css/built.[contenthash:10].css'
    }),
  ],
  mode: 'production',
  devtool: 'source-map'
}
```

#### hash/chunkhash/contenthash

- hashï¼šæ¯æ¬¡webpackæ„å»ºæ—¶ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„hashå€¼ï¼›
  - é—®é¢˜ï¼šå› ä¸ºjså’Œcssä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªhashå€¼ã€‚ä½¿ç”¨[hash:10]é‡æ–°æ‰“åŒ…åï¼Œä¼šå¯¼è‡´æ‰€æœ‰çš„ç¼“å­˜éƒ½å¤±æ•ˆäº†ï¼ˆå› ä¸ºjså’Œcssçš„æ–‡ä»¶åéƒ½å˜äº†ï¼Œä½†å¯èƒ½æ­¤æ—¶åªæ”¹åŠ¨äº†ä¸€ä¸ªæ–‡ä»¶ï¼‰
- chunkhashï¼šæ ¹æ®chunkç”Ÿæˆçš„hashå€¼ã€‚å¦‚æœæ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶æ¥æºäºä¸€ä¸ªchunkï¼Œé‚£ä¹ˆhashå€¼å°±ä¸€æ ·ã€‚
  - é—®é¢˜ï¼šåŒä¸€ä¸ªchunkï¼Œjså’Œcssä½¿ç”¨çš„hashå€¼è¿˜æ˜¯åŒä¸€ä¸ªã€‚ä¾ç„¶å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼ŒåŸå› åœºæ™¯åŒä¸Šã€‚
- contenthashï¼šæ ¹æ®æ–‡ä»¶çš„å†…å®¹ç”Ÿæˆhashå€¼ã€‚
  - åªè¦æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œhashå€¼å°±ä¼šæ”¹å˜ï¼ˆå†…å®¹ä¸å˜ï¼Œhashå€¼ä¹Ÿä¸å˜ï¼‰ï¼›
  - è¿™æ ·ï¼Œä¸åŒæ–‡ä»¶çš„hashå€¼ä¸€å®šä¸åŒï¼›
  - å®Œç¾è§£å†³äº†ä¸Šè¾¹çš„é—®é¢˜ã€‚

**å°ç»“ï¼š** æœ€ä¼˜è§£æ˜¯**contenthash**ã€‚

## ã€æ€§èƒ½ã€tree shakingï¼ˆæ ‘æ‘‡ï¼‰

### ç®€ä»‹

>æƒ³è±¡æœ‰æ£µæ ‘ï¼š  
>æ ‘ä¸Šæœ‰ç»¿è‰²å’Œæ¯é»„çš„å¶å­ï¼Œä¸ºäº†åªä¿ç•™ç»¿è‰²çš„å¶å­ï¼Œæœ‰ä¸ªäººå°±å»æ‘‡æ™ƒè¿™æ£µæ ‘ï¼Œå°†æ¯é»„å¶ç‰‡æ‘‡è½ä¸‹æ¥ã€‚

ç±»æ¯”ä¸Šé¢é‚£æ£µæ ‘ï¼Œwebpackä¸­çš„tree shakingå³**å»é™¤æ²¡æœ‰ç”¨è¿‡çš„ä»£ç ï¼Œå‡å°æ‰“åŒ…åä»£ç ä½“ç§¯**ã€‚

### é…ç½®

- é¦–å…ˆï¼Œå†™ä»£ç æ—¶å¿…é¡»ä½¿ç”¨ES6æ¨¡å—åŒ–ï¼›
- å¼€å¯`production`æ¨¡å¼ï¼ˆæˆ–å¼•ç”¨ä¸€ä¸ªèƒ½å¤Ÿåˆ é™¤æœªå¼•ç”¨ä»£ç çš„å‹ç¼©å·¥å…·ï¼Œæ¯”å¦‚`UglifyJSPlugin`ï¼‰ï¼›
- é¿å…åªimportå´æœªè°ƒç”¨çš„æ–‡ä»¶ï¼ˆç±»ä¼¼äºcssã€@babel/polyfillè¿™ç§ï¼‰è¢«å¹²æ‰ï¼Œè¿˜éœ€è®¾ç½®package.jsonçš„`sideEffects`ï¼š
  - `"sideEffects": false`ï¼šæ‰€æœ‰ä»£ç éƒ½æ²¡æœ‰å‰¯ä½œç”¨ï¼ˆéƒ½å¯ä»¥è¢«æ‘‡æ‰ï¼Œå¯èƒ½ä¼šå¹²æ‰cssã€@babel/polyfillï¼‰ï¼›
  - `"sideEffects": ["*.css", "*.less"]`ï¼šç›¸å½“äºæ’é™¤äº†"*.css"ã€ "*.less"ä¸¤ç§æ–‡ä»¶ã€‚

## ã€æ€§èƒ½ã€code split

### ç®€ä»‹

ä»£ç åˆ†ç¦»å°±æ˜¯æŠŠä»£ç åˆ†ç¦»åˆ°ä¸åŒçš„bundleä¸­ï¼Œç„¶åå¯ä»¥æŒ‰éœ€åŠ è½½æˆ–å¹¶è¡ŒåŠ è½½è¿™äº›æ–‡ä»¶ã€‚ä»£ç åˆ†ç¦»å¯ä»¥ç”¨äºè·å–æ›´å°çš„ bundleï¼Œä»¥åŠæ§åˆ¶èµ„æºåŠ è½½ä¼˜å…ˆçº§ï¼Œå¦‚æœä½¿ç”¨åˆç†ï¼Œä¼šæå¤§å½±å“åŠ è½½æ—¶é—´ã€‚

å¸¸ç”¨çš„ä»£ç åˆ†ç¦»æœ‰ä¸‰ç§æ–¹æ³•ï¼š

- å…¥å£èµ·ç‚¹ï¼šé…ç½®å¤šå…¥å£ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå…¥å£ä¼šæ‰“åŒ…æˆä¸€ä¸ªbundleï¼›
- é˜²æ­¢é‡å¤ï¼šä½¿ç”¨[Entry dependencies](https://webpack.docschina.org/configuration/entry-context/#dependencies)æˆ–è€…[SplitChunksPlugin](https://webpack.docschina.org/plugins/split-chunks-plugin/)å»é‡å’Œåˆ†ç¦» chunkï¼›
- åŠ¨æ€å¯¼å…¥ï¼šé€šè¿‡æ¨¡å—çš„å†…è”å‡½æ•°è°ƒç”¨æ¥åˆ†ç¦»ä»£ç ã€‚

### å…¥å£èµ·ç‚¹-é…ç½®å¤šå…¥å£ï¼ˆdemo1ï¼‰

ä¸€ä¸ªå…¥å£è¢«æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ã€‚

#### é…ç½®

æˆ‘ä»¬æœ‰ä¸¤ä¸ªjsï¼ˆsrc/js/index.jså’Œsrc/js/test.jsï¼‰ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰äº’ç›¸å¼•ç”¨ï¼Œå®Œå…¨ç‹¬ç«‹ï¼Œä¹Ÿæ²¡æœ‰importå…¬å…±åº“æˆ–æ–¹æ³•ã€‚è€Œåœ¨webpacké…ç½®äº†ä¸¤ä¸ªå…¥å£ã€‚

##### é…ç½®è¦ç‚¹ğŸ‘‡

ä¿®æ”¹entryä¸ºå¤šå…¥å£ï¼š

```js
entry: {
  // å¤šå…¥å£ï¼šæœ‰ä¸€ä¸ªå…¥å£ï¼Œæœ€ç»ˆè¾“å‡ºå°±æœ‰ä¸€ä¸ªbundle
  index: './src/js/index.js',
  test: './src/js/test.js'
}
```

##### å®Œæ•´ä»£ç ğŸ‘‡

```js
// æ–‡ä»¶ï¼šsrc/js/index.js
function sum(...args) {
  return args.reduce((p, c) => p + c, 0);
}
// eslint-disable-next-line
console.log(sum(1, 2, 3, 4));
```

```js
// æ–‡ä»¶ï¼šsrc/js/test.js
export function mul(x, y) {
  return x * y;
}
export function count(x, y) {
  return x - y;
}
```

```js
// æ–‡ä»¶ï¼šwebpack.config.js
const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  // å•å…¥å£
  // entry: './src/js/index.js',
  entry: {
    // å¤šå…¥å£ï¼šæœ‰ä¸€ä¸ªå…¥å£ï¼Œæœ€ç»ˆè¾“å‡ºå°±æœ‰ä¸€ä¸ªbundle
    index: './src/js/index.js',
    test: './src/js/test.js'
  },
  output: {
    filename: 'js/[name].[contenthash:10].js', // [name]ï¼šå–æ–‡ä»¶å
    path: resolve(__dirname, 'build')
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        collapseWhitespace: true,
        removeComments: true
      }
    })
  ],
  mode: 'production'
};

```

#### æ•ˆæœ

ä¸¤ä¸ªå…¥å£è¢«æ‰“åŒ…æˆä¸¤ä¸ªæ–‡ä»¶ï¼š

![](https://gitee.com/ahuang6027/blog-images/raw/master/images/code-split-demo1.png)

### é˜²æ­¢é‡å¤ - é…ç½®splitChunksï¼ˆdemo2ï¼‰

Entry dependenciesæ˜¯åœ¨å…¥å£é…ç½®ä½¿ç”¨åˆ°çš„å…¬å…±åº“ï¼Œä»è€Œè¿›è¡Œæ‰“åŒ…ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œéœ€è¦çŸ¥é“å…¬å…±åº“å…·ä½“æ˜¯ä»€ä¹ˆï¼Œæ¯”è¾ƒé€‚åˆå…¬å…±åº“è¾ƒå°‘æ—¶ã€‚

è¿™é‡Œä¸»è¦è®²ä½¿ç”¨splitChunkPluginï¼Œå¯¹Entry dependenciesæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹[è¿™é‡Œ](https://webpack.docschina.org/guides/code-splitting/#entry-dependencies)

#### é…ç½®

åœ¨demo1çš„åŸºç¡€ä¸Šï¼Œå¾€test.jså’Œindex.jséƒ½å¼•å…¥jqueryï¼Œå¹¶æ‰“å°ä¸€ä¸‹ã€‚ç„¶ååœ¨webpack.config.jsä¸­é…ç½®SplitChunksPluginã€‚

##### é…ç½®è¦ç‚¹ğŸ‘‡

- entryä¸ºå¤šå…¥å£ï¼š

  ```js
  entry: {
    // å¤šå…¥å£ï¼šæœ‰ä¸€ä¸ªå…¥å£ï¼Œæœ€ç»ˆè¾“å‡ºå°±æœ‰ä¸€ä¸ªbundle
    index: './src/js/index.js',
    test: './src/js/test.js'
  }
  ```

- é…ç½®splitChunksPluginï¼š

  ```js
  optimization: {
    splitChunks: {
      chunks: 'all'
    }
  }
  ```

##### å®Œæ•´ä»£ç ğŸ‘‡

```js
// æ–‡ä»¶ï¼šsrc/js/index.js
import $ from 'jquery';

function sum(...args) {
  return args.reduce((p, c) => p + c, 0);
}

// eslint-disable-next-line
console.log(sum(1, 2, 3, 4));
// eslint-disable-next-line
console.log($);
```

```js
// æ–‡ä»¶ï¼šsrc/js/test.js
import $ from 'jquery';
// eslint-disable-next-line
console.log($);
export function mul(x, y) {
  return x * y;
}
export function count(x, y) {
  return x - y;
}
```

```js
// æ–‡ä»¶ï¼šwebpack.config.js
const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  entry: {
    // å¤šå…¥å£ï¼šæœ‰ä¸€ä¸ªå…¥å£ï¼Œæœ€ç»ˆè¾“å‡ºå°±æœ‰ä¸€ä¸ªbundle
    index: './src/js/index.js',
    test: './src/js/test.js'
  },
  output: {
    filename: 'js/[name].[contenthash:10].js', // [name]ï¼šå–æ–‡ä»¶å
    path: resolve(__dirname, 'build')
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        collapseWhitespace: true,
        removeComments: true
      }
    })
  ],
  /*
    1. å¯ä»¥å°†node_modulesä¸­ä»£ç å•ç‹¬æ‰“åŒ…ä¸€ä¸ªchunkæœ€ç»ˆè¾“å‡º
    2. è‡ªåŠ¨åˆ†æå¤šå…¥å£chunkä¸­ï¼Œæœ‰æ²¡æœ‰å…¬å…±çš„æ–‡ä»¶ã€‚å¦‚æœæœ‰ä¼šæ‰“åŒ…æˆå•ç‹¬ä¸€ä¸ªchunk
  */
  optimization: {
    splitChunks: {
      chunks: 'all'
    }
  },
  mode: 'production'
};
```

#### æ•ˆæœ

ä¸demo1ç›¸æ¯”ï¼Œå¤šäº†ä¸€ä¸ªjsæ–‡ä»¶ï¼Œå®ƒå…¶å®å°±æ˜¯å¼•å…¥çš„å…¬å…±jqueryã€‚

- ç”±ä¸¤ä¸ªå…¥å£å‡ºå‘ï¼Œåˆ†åˆ«æ‰“åŒ…æˆä¸¤ä¸ªæ–‡ä»¶ï¼›
- å…¥å£æ–‡ä»¶ä¸­çš„å…¬å…±éƒ¨åˆ†-jqueryï¼Œè¢«åˆ†ç¦»å‡ºæ¥å•ç‹¬æ‰“åŒ…ï¼›

![](https://gitee.com/ahuang6027/blog-images/raw/master/images/code-split-demo2-å¼•å…¥jq.png)

### <h3 id="split-chunk-3">åŠ¨æ€å¯¼å…¥ - å•å…¥å£ + é…ç½®splitChunks + åŠ¨æ€importï¼ˆdemo3ï¼‰</h3>

ç°åœ¨å•é¡µåº”ç”¨éå¸¸æ™®éã€‚å¦‚æœæ˜¯å•é¡µåº”ç”¨ï¼ˆåªæœ‰ä¸€ä¸ªå…¥å£ï¼‰ï¼Œåˆæƒ³åˆ†ç¦»jsä»£ç ï¼Œå°±éœ€è¦ç”¨åŠ¨æ€importã€‚

#### é…ç½®

##### é…ç½®è¦ç‚¹ğŸ‘‡

- å•å…¥å£ï¼š

  ```js
  module.exports={
    entry: './src/js/index.js'
  }
  ```

- åœ¨å…¥å£æ–‡ä»¶src/js/index.jsä¸­åŠ¨æ€å¼•å…¥ï¼š

  ```js
  import(/* webpackChunkName: 'test' */'./test') // /* webpackChunkName: 'test' */ - é…ç½®åï¼Œæ‰“åŒ…åçš„æ–‡ä»¶åä¸ºtest.xxx
  .then(({ mul, count }) => {
    // eslint-disable-next-line
    console.log('æ–‡ä»¶åŠ è½½æˆåŠŸ~', mul(2, 5), count(6, 3));
  })
  .catch(() => {
    // eslint-disable-next-line
    console.log('æ–‡ä»¶åŠ è½½å¤±è´¥~');
  })
  ```

##### å®Œæ•´ä»£ç ğŸ‘‡

```js
// æ–‡ä»¶ï¼šsrc/js/index.js
function sum(...args) {
  return args.reduce((p, c) => p + c, 0);
}
// eslint-disable-next-line
console.log(sum(1, 2, 3, 4));

/**
 * é€šè¿‡åŠ¨æ€importï¼Œå°†importçš„æ–‡ä»¶è¢«å•ç‹¬æ‰“åŒ…æˆchunk
 */
import(/* webpackChunkName: 'test' */'./test')
  .then(({ mul, count }) => {
    // eslint-disable-next-line
    console.log('æ–‡ä»¶åŠ è½½æˆåŠŸ~', mul(2, 5), count(6, 3));
  })
  .catch(() => {
    // eslint-disable-next-line
    console.log('æ–‡ä»¶åŠ è½½å¤±è´¥~');
  })
```

```js
// æ–‡ä»¶ï¼šsrc/js/test.js
export function mul(x, y) {
  return x * y;
}
export function count(x, y) {
  return x - y;
}
```

```js
// æ–‡ä»¶ï¼šwebpack.config.jsmodule.exports = {
  // å•å…¥å£
  entry: './src/js/index.js',
  output: {
    // [name]ï¼šå–æ–‡ä»¶å
    filename: 'js/[name].[contenthash:10].js',
    path: resolve(__dirname, 'build')
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        collapseWhitespace: true,
        removeComments: true
      }
    })
  ],
  optimization: {
    splitChunks: {
      chunks: 'all'
    }
  },
  mode: 'production'
};
};
```

#### æ•ˆæœ

index.jså’Œtest.jsè¢«å•ç‹¬æ‰“åŒ…æˆä¸¤ä¸ªæ–‡ä»¶ï¼š
![](https://gitee.com/ahuang6027/blog-images/raw/master/images/code-split-demo3.png)

## æ‡’åŠ è½½å’Œé¢„è·å–

### ç®€ä»‹

éƒ½éœ€è¦ä»¥ä»£ç åˆ†ç¦»ä¸ºåŸºç¡€~

- æ‡’åŠ è½½ï¼šå½“æ–‡ä»¶éœ€è¦ä½¿ç”¨æ—¶æ‰åŠ è½½ï¼›
- é¢„è·å–ï¼ˆprefetchï¼‰ï¼š
  - åœ¨æ–‡ä»¶ä½¿ç”¨å‰ï¼Œæå‰åŠ è½½jsæ–‡ä»¶ã€‚
  - ã€â—æ³¨æ„ã€‘è¿™é‡Œè¯¾ä¸Šè€å¸ˆè¯´çš„æ˜¯é¢„åŠ è½½ï¼Œå…¶å®prefetchæ˜¯é¢„è·å–ï¼Œpreloadæ‰æ˜¯é¢„åŠ è½½ï¼Œå…·ä½“çœ‹[webpackå®˜ç½‘](https://webpack.docschina.org/guides/code-splitting/#prefetchingpreloading-modules)ã€‚
  - ä¸æ­£å¸¸åŠ è½½çš„åŒºåˆ«ï¼š
    - æ­£å¸¸åŠ è½½ï¼šå¯ä»¥è®¤ä¸ºæ˜¯å¹¶è¡ŒåŠ è½½ï¼ˆåŒä¸€æ—¶é—´åŠ è½½å¤šä¸ªæ–‡ä»¶ï¼‰ï¼›
    - é¢„è·å–ï¼šç­‰å…¶ä»–èµ„æºåŠ è½½å®Œæ¯•ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™ï¼Œå†å·å·åŠ è½½èµ„æºã€‚

### é…ç½®

> è¿™é‡Œä»£ç åˆ†ç¦»é‡‡ç”¨çš„æ˜¯[ä»£ç åˆ†ç¦»ç¬¬3ç§æ–¹å¼](#split-chunk-3)

é¦–å…ˆï¼Œæˆ‘çš„ä»£ç åˆ†ç¦»é…ç½®ä¸ºï¼š

```js
// webpack.config.js

module.exports = {
  // å•å…¥å£
  entry: './src/js/index.js',
  output: {
    // [name]ï¼šå–æ–‡ä»¶å
    filename: 'js/[name].[contenthash:10].js',
    path: resolve(__dirname, 'build')
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        collapseWhitespace: true,
        removeComments: true
      }
    })
  ],
  optimization: {
    splitChunks: {
      chunks: 'all'
    }
  },
  mode: 'production'
};
```

#### æ‡’åŠ è½½

åœ¨æŸä¸ªäº‹ä»¶è§¦å‘æ—¶ä½¿ç”¨ï¼š`import(/* webpackChunkName: 'test' */'./test').then(({ mul }) => {}).catch(() => {})`

##### å®Œæ•´ä»£ç 

```js
// test.js
console.log('test.jsæ–‡ä»¶è¢«åŠ è½½äº†~');
export function mul(x, y) {
  return x * y;
}
export function count(x, y) {
  return x - y;
}

// index.js
console.log('index.jsæ–‡ä»¶è¢«åŠ è½½äº†~');
document.getElementById('btn').onclick = function() {
  import(/* webpackChunkName: 'test' */'./test')
    .then(({ mul }) => {
      console.log('test.jsåŠ è½½æˆåŠŸäº†~ ', mul(3, 4))
    })
    .catch(() => {
      console.log('test.jsåŠ è½½å¤±è´¥äº†~')
    })
};
```

##### æ•ˆæœ

![æ‡’åŠ è½½](https://gitee.com/ahuang6027/blog-images/raw/master/images/æ‡’åŠ è½½.png)

#### é¢„è·å–

é…ç½®ï¼š`import(/* webpackPrefetch: true */'./test').then(() => {}).catch(() => {})`

##### å®Œæ•´ä»£ç 

```js
// test.js
console.log('test.jsæ–‡ä»¶è¢«åŠ è½½äº†~');
export function mul(x, y) {
  return x * y;
}
export function count(x, y) {
  return x - y;
}

// index.js
console.log('index.jsæ–‡ä»¶è¢«åŠ è½½äº†~');
document.getElementById('btn').onclick = function() {
  import(/* webpackChunkName: 'test', webpackPrefetch: true */'./test')
    .then(({ mul }) => {
      console.log('test.jsåŠ è½½æˆåŠŸäº†~ ', mul(3, 4))
    })
    .catch(() => {
      console.log('test.jsåŠ è½½å¤±è´¥äº†~')
    })
};
```

##### æ•ˆæœ

![é¢„è·å–](https://gitee.com/ahuang6027/blog-images/raw/master/images/é¢„åŠ è½½.png)

## PWA

### ç®€ä»‹

PWA - æ¸è¿›å¼ç½‘ç»œåº”ç”¨ç¨‹åº(Progressive Web Application)ï¼Œæ˜¯ä¸€ç§å¯ä»¥æä¾›ç±»ä¼¼äºåŸç”Ÿåº”ç”¨ç¨‹åº(native app)ä½“éªŒçš„ç½‘ç»œåº”ç”¨ç¨‹åº(web app)ã€‚å®ƒå¯ä»¥ç”¨æ¥åšå¾ˆå¤šäº‹ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯ï¼Œåœ¨ç¦»çº¿(offline)æ—¶åº”ç”¨ç¨‹åºèƒ½å¤Ÿç»§ç»­è¿è¡ŒåŠŸèƒ½ã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨åä¸º`Service Workers`çš„ç½‘ç»œæŠ€æœ¯æ¥å®ç°çš„ã€‚

### é…ç½®

1. é¦–å…ˆï¼Œæ·»åŠ `workbox-webpack-plugin`:
   - `workbox`: webpackçš„pwaåˆ©ç”¨åä¸º`Workbox`çš„ Google é¡¹ç›®æ¥å®ç°pwaç¦»çº¿æ•ˆæœï¼Œè¯¥é¡¹ç›®æä¾›çš„å·¥å…·å¯å¸®åŠ©æˆ‘ä»¬æ›´è½»æ¾åœ°é…ç½® web app çš„ç¦»çº¿æ”¯æŒï¼›
   - ä¸‹è½½ï¼š`npm i workbox-webpack-plugin -D`;
   - åœ¨`webpack.config.js`ä¸­æ·»åŠ ï¼š

    ```js
      new WorkboxWebpackPlugin.GenerateSW({
        // 1. å¸®åŠ©serviceWorkerå¿«é€Ÿå¯åŠ¨ï¼› 2. åˆ é™¤æ—§çš„serviceWorkerï¼›
        // æœ€ç»ˆç”Ÿæˆä¸€ä¸ªserviceWorkerçš„é…ç½®æ–‡ä»¶ã€‚
        clientsClaim: true,
        skipWaiting: true,
      }),
    ```

2. ä¿®æ”¹jsä»£ç ï¼Œæ³¨å†Œä½¿ç”¨`Service Worker`ï¼š

   ```js
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/service-worker.js')
          .then(() => {
            console.log('swæ³¨å†ŒæˆåŠŸäº†~');
          })
          .catch(() => {
            console.log('swæ³¨å†Œå¤±è´¥äº†~');
          });
      });
    }
   ```

3. ã€æ³¨æ„â—ã€‘å¦‚æœwebpacké…ç½®äº†eslintï¼Œeslinté»˜è®¤ä¸è®¤è¯†`window`, `navigator`ç­‰å…¨å±€å˜é‡ï¼Œè¿˜éœ€è¦ä¿®æ”¹package.jsonä¸­`eslintConfig`ï¼š

   ```js
    "eslintConfig": {
      "env": {
        "browser": true
      }
    },
   ```

4. ã€æ³¨æ„â—ã€‘swä»£ç å¿…é¡»è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥ä¸‹è½½`npm i serve`ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„æ˜¯`webpackDevServer`ï¼‰ï¼Œå†`serve -s build`å¯åŠ¨æœåŠ¡å™¨ï¼Œå°†buildç›®å½•ä¸‹æ‰€æœ‰èµ„æºä½œä¸ºé™æ€èµ„æºæš´éœ²å‡ºå»ã€‚

### æ•ˆæœ

![cache](https://gitee.com/ahuang6027/blog-images/raw/master/images/webpack-pwa-cache.png)
![serviceWorker](https://gitee.com/ahuang6027/blog-images/raw/master/images/webpack-pwa-service-worker.png)
