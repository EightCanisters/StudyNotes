> ⚡⚡本文是以Chrome为例，了解Chrome内部有哪些进程/线程⚡⚡

## 1. 前置知识

咱们先来复习一下👩‍💻：

### 1.1. CPU（中央处理器，Central Processing Unit）

- CPU是计算机里的一块芯片，上面有一个或多个核心（core）（很久之前大多数CPU只有一个核心）；  
- 每个核心都是个劳模，都可以串行地一个接一个地处理交给它的任务。

### 1.2. GPU（图形处理器，Graphics Processing Unit）

- GPU是计算机另外一个很重要的组成部分；
- GPU与CPU不同，单个GPU核心只能处理一些简单的任务，但GPU上有很多核心可以同时工作，它的并行计算能力非常强大；
- GPU一开始就是专门用来处理图形的，近几年随着GPU加速概念的流行，在GPU上单独进行的计算也变得越来越多。

### 1.3. 进程（Process）和线程（Thread）

> 上一篇文章详细介绍了进程和线程，所以这里就简单提一下，不是很理解的朋友请戳：[进程&线程](https://www.yuque.com/docs/share/13d7cb2c-edd0-40cc-bbd7-e96c43a5e35f)

当我们在手机或者电脑上打开某个应用的时候，操作系统会为这个应用创建一个或多个进程，同时为这些进程分配好各自的私有的内存空间，然后交由CPU执行（也会涉及GPU绘制）。而线程是跑在进程里面的，一个进程里可能有一个或多个线程。

## 2. 浏览器进程架构的发展

### 2.1. 早期的单进程架构

以前（大概是2007年之前），市面上浏览器都是单进程的。  
单进程架构是指浏览器的所有功能模块都运行在同一个进程中，包含网络、插件、JS运行、渲染引擎、页面等等……  
同一个进程内的线程是共享进程的资源的，而一个线程崩溃会导致整个进程崩溃。所以单进程架构的浏览器，基本都有**不稳定、不流畅、不安全**的缺点：

- **不稳定**：早期浏览器需要借助于插件来实现诸如 Web 视频、Web 游戏等各种强大的功能，但是插件是最容易出问题的模块；而且渲染引擎模块也是不稳定的，通常一些复杂的 JavaScript 代码就有可能引起渲染引擎模块的崩溃。一旦出问题崩溃会导致整个浏览器的崩溃。
- **不流畅**：单进程浏览器页面的渲染模块、JavaScript 执行环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块可以执行。除了脚本或者插件会让单进程浏览器变卡顿外，页面的内存泄漏也是单进程变慢的一个重要原因。通常浏览器的内核都是非常复杂的，运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变得越慢。
- **不安全**：插件可以使用 C/C++ 等代码编写，通过插件可以获取到操作系统的任意资源，当你在页面运行一个插件时也就意味着这个插件能完全操作你的电脑。如果是个恶意插件，那么它就可以释放病毒、窃取你的账号密码，引发安全性问题。至于页面脚本，它可以通过浏览器的漏洞来获取系统权限，这些脚本获取系统权限之后也可以对你的电脑做一些恶意的事情，同样也会引发安全问题。

### 2.2. 如今的多进程架构

> 其实多进程架构也有它的演变过程，也存在早期版本，但这里就不展开了，感兴趣的朋友戳这里：[Chrome进程架构](https://www.jianshu.com/p/4df6bcf5de95)

#### 2.2.1. 多进程架构的好坏

**优点：**

- 多进程可以是浏览器**具有很好的容错性**。单个tab页崩溃不会影响到整个浏览器，同样，第三方插件崩溃页不会影响到整个浏览器。
- 多进程架构可以**提供安全性和沙盒性（sanboxing）**。因为操作系统提供方法让浏览器拥有限制每个进程的能力，所以浏览器可以让某些进程不具备某些特定的功能。如：由于tab渲染进程可能会处理来自用户的随即输入，所以Chrome限制了它们对系统文件随机读写的能力。
- 多线程可以充分利用现代CPU多喝的优势。

**缺点：**

  **进程的内存消耗**。由于每个进程都有各自独立的内存空间，这就造成了一些基础的架构（例如V8 JS引擎）会在不同进程的内存空间同时存在的问题，这些重复的内容会消耗更多的内存。

  所以为了节省内存，Chrome会限制被启动的进程数目，**当进程数达到一定的界限后，Chrome会把访问同一个网站的tab都放在一个进程里面跑**。

## 3. Chrome的进程&线程

### 3.1. Chrome的进程

> 除了下面列出来的进程，Chrome其实还有很多其他进程在工作，例如扩展进程（Extension Process）、工具进程（Utility Process）。  
> 如果你想看一下你的Chrome浏览器现在有多少个进程在跑可以点击浏览器右上角的更多按钮，选择更多工具和任务管理器。

![Chrome的多进程](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-of-chrome.png)

- **浏览器进程（Browser Process，很多文章又称“主进程”）**：
  - 浏览器的主进程，只有一个；
  - 负责浏览器的“Chrome”部分，包括用户交互、导航栏、数千、前进、后退、收藏等；
  - 协调控制浏览器的其他进程，包括创建、销毁等；
  - 会和其他进程一起协作来实现浏览器的功能；
  - 处理我们看不见的部分，包括网络请求的发送、文件的读写等。
- **渲染进程（Renderer Process）**：
  - 就是我们常说的**浏览器内核**，排版引擎Blink和JS引擎V8都运行在该进程中；
  - **Chrome会尽可能为每个Tab页甚至是页面内的每个iframe都分配一个单独的渲染进程**；
  - 负责Tab页内**与网页展示相关的所有工作**，包括脚本执行、事件处理等。
- **第三方插件进程（Plugin Process）**：
  - 控制网页使用的所有插件，例如flash插件。
  - 每种类型的插件对应一个进程，仅当使用该插件时才创建。
- **GPU进程（GPU Process）**：
  - 最多只有一个；
  - 负责独立于其它进程的GPU任务，如3D绘制；
  - 它被独立为一个进程是因为它要处理来自于不同tab的渲染请求并把它在同一个界面上画出来。

### 3.2. Chrome的线程

#### 3.2.1. 每个进程下都含有的线程

> IPC：Inter Process Communication，进程间通信，需要通过IPC机制来进行。

[Chromium官方文档](https://chromium.googlesource.com/chromium/src/+/HEAD/docs/threading_and_tasks.md#threads)是这样描述的：  
![](https://gitee.com/ahuang6027/blog-images/raw/master/images/threads-of-chromium.png)

翻译一下，每个Chrome进程中都含有：

- 1个主线程：
  - 在Browser进程里：用于更新UI界面；
  - 在Renderer进程里：运行大部分Blink代码；
- 1个IO线程：
  - 在所有进程里：所有IPC消息到达这个线程。处理消息的应用程序逻辑可能在不同的线程中(例如，IO线程可能将消息路由到绑定到不同线程的Mojo接口)；
  - 大部分异步IO都发生在此线程；
- 一些特殊用途的线程；
- 一个通用线程池。
大多数线程都有一个loop，它从队列中获取任务并运行(队列可以在多个线程之间共享)。

> 也许你跟我一样疑惑，Blink是个啥？？？（这里推荐阅读[你能分得清楚 Chromium, V8, Blink, Gecko, WebKit 之间的区别吗？](https://juejin.cn/post/6844904055236460558)）
> **Blink是Google Chrome浏览器的渲染引擎，V8是Blink内置的JS引擎。**  
> Blink干了这些事：  
> ![](https://gitee.com/ahuang6027/blog-images/raw/master/images/what-does-blink-does.png)

#### 3.2.2. Renderer进程下的线程

> 🤦‍♀️🤦‍♀️其实Renderer进程下的线程我不是很确定，没有找到最近的官方文档==  
> 只是[Inside look at modern web browser(part1 - part4)](https://developers.google.com/web/updates/2018/09/inside-browser-part2)中说到有合成器线程、栅格化线程、主线程，包括DevTools里也只显示出来这几个线程。但很多文章基本都说到了有EventLoop相关的那几个线程。所以接下来我就以DevTools的为准，其余的也提一嘴。。。  
> 跪求伙伴们指正🙏🙏

##### 3.2.2.1. 说法1：从DevTools看线程（个人认为比较准确）

![从DevTools - Performance看线程](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-devtool-performance.png)

上图中主要有三个线程：

- **主线程**：它执行了许多任务，包括：
  - HTML/CSS的解析、布局(Layout)，绘画(Paint)、分层；
  - JavaScript的解析和执行。
  - 【❗注意】在说法2中，JS的解析执行是由JS引擎线程负责的，而JS引擎线程与主线程互斥。而我们知道，JS会阻塞文档的解析，在当前的说法1中，我们可以理解成：主线程资源有限，只能分配给其中一个任务执行（具体可以看[这篇文章](https://mp.weixin.qq.com/s/nZd3846YTBbpj8AYgs1jqQ)）。
- **合成器线程(compositor thread)**：进行分块操作，同时也负责接收用户的滚动、输入，分发回调事件等。
- **栅格化线程**：将绘制命令转换为位图或者GPU能识别的纹理。

##### 3.2.2.2. 说法2（个人认为过时了，但很多思想还是没变的，eventloop也可以从这方面去理解）

- **GUI渲染线程(主线程)**：
  - 只有一个；
  - 负责初始渲染工作：解析HTML，解析CSS，构建DOM树、CSSOM树，整个渲染树，进行布局和绘制；
  - 页面需要重绘和回流时，该线程会执行；
  - 与JS引擎线程**互斥**（不能同时运行）。当JS引擎执行时，GUI线程会被挂起。
- **JS引擎线程**：
  - 只有一个；
  - 负责运行JS引擎(V8)：解析和执行JS代码；
  - JS引擎中有一个**任务队列**，JS引擎会轮询检查任务队列中是否有任务到来，一旦有任务到来，立即**按顺序推到执行栈**中执行；
  - 与GUI渲染线程互斥。
- **事件触发线程**：
  - 只有一个；
  - 主要职能是控制事件循环（鼠标点击、`setTimeout`、`ajax`等）；
  - 当JS引擎线程执行JS遇到宏/微任务时，会将宏/微任务加入到**事件触发线程的对应队列中**。事件触发线程会跟踪任务的触发时机，时机到时将任务从各自队列中取出，放入**JS引擎任务队列**中等待执行。JS引擎会在自己空闲的时候，从任务队列中依次取出到**执行栈**中执行。
- **定时器触发线程**：
  - 用于`setTimeout`/`setInterval`的计时。因为JS引擎是单线程的，如果将计时交给JS引擎来做，当它处于阻塞状态时就会影响计时的准确，所以单独使用独立的线程来计时；
  - 时间到，则**通知事件触发线程**，事件触发线程将定时器对应的任务放到**JS引擎的任务队列中等待执行**。
- **异步Http请求线程**：
  - 处理`XMLHttpRequest`请求；
  - 当检测到`XMLHttpRequest`状态变更时(有结果返回)，并且设置有回调函数，异步Http请求线程就会**通知事件触发线程**，事件触发线程将回调任务放入**JS引擎的任务队列中等待执行**。

#### 3.2.3. Browser进程下的线程

- **UI线程**：用于绘制浏览器顶部按钮和导航栏输入框等组件；
- **Storage线程**：控制文件读写；
- **NetWork线程**：管理网络请求。

### 3.3. 小结

整个Chrome的进程和线程，可以总结为下图：
  
![Chrome的进程&线程](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-and-threads-structure.png)

tip：原脑图在[这里](https://www.yuque.com/docs/share/4937f2cb-0c37-4849-bf8a-b85eed335c25)

## 4. 展望

本文只是记录了浏览器中各个进程和线程的作用，但它们具体是如何协作的，我们可能还有点晕乎，所以后边会从下面两个角度来看：

- 从进程&线程看页面渲染：
  有位[大佬](http://marswiz.com/blog/2021/09/20/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/)总结成了图，我在其基础上改成适应说法1的了：  
  ![进程&线程-渲染](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-parse-render-pipeline.png)
- 从进程&线程看EventLoop。

## 5. 参考

- [Inside look at modern web browser(part1 - part4)](https://developers.google.com/web/updates/2018/09/inside-browser-part2)
- [一文看懂Chrome浏览器运行机制](https://zhuanlan.zhihu.com/p/102149546)
- [浏览器进程与线程](https://juejin.cn/post/6906462594001960974)
- [从 8 道面试题看浏览器渲染过程与性能优化](https://juejin.cn/post/6844904040346681358)
- [从浏览器多线程到JS单线程，JS运行机制最全面的一次梳理](https://juejin.cn/post/6844903553795014663)
- [深入理解浏览器中的进程与线程](https://juejin.cn/post/6991849728493256741)
- [前端开发者应该明白的浏览器原理](https://juejin.cn/post/6844903780148838414)
- [Chrome进程架构](https://www.jianshu.com/p/4df6bcf5de95)
- [你能分得清楚 Chromium, V8, Blink, Gecko, WebKit 之间的区别吗？](https://juejin.cn/post/6844904055236460558)
- [浏览器的进程、线程与页面渲染流程](http://marswiz.com/blog/2021/09/20/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/)
