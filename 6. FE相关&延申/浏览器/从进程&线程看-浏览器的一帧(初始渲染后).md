## 前言

前边学习了：

1. [什么是进程线程](https://github.com/FE-Huang/StudyNotes/blob/master/6.%20FE%E7%9B%B8%E5%85%B3%26%E5%BB%B6%E7%94%B3/%E6%B5%8F%E8%A7%88%E5%99%A8/Chrome%E7%9A%84%E8%BF%9B%E7%A8%8B%26%E7%BA%BF%E7%A8%8B.md)
2. [Chrome的进程&线程](https://github.com/FE-Huang/StudyNotes/blob/master/6.%20FE%E7%9B%B8%E5%85%B3%26%E5%BB%B6%E7%94%B3/%E6%B5%8F%E8%A7%88%E5%99%A8/%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B(%E8%BF%9B%E7%A8%8B%26%E7%BA%BF%E7%A8%8B%E8%A7%92%E5%BA%A6).md)（以说法1为准，说法2仅供参考）:  
  ![Chrome的进程&线程](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-and-threads-structure.png)
3. [从进程&线程看-页面渲染流程](https://github.com/FE-Huang/StudyNotes/blob/master/6.%20FE%E7%9B%B8%E5%85%B3%26%E5%BB%B6%E7%94%B3/%E6%B5%8F%E8%A7%88%E5%99%A8/%E4%BB%8E%E8%BF%9B%E7%A8%8B%26%E7%BA%BF%E7%A8%8B%E7%9C%8B-%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.md):  
  ![进程&线程-渲染](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-parse-render-pipeline.png)

这篇笔记其实是查找“页面渲染流程”资料的过程中，阅读到的一个被我忽略的东西，建议伙伴们在看完前边的笔记（或者看完我放的截图）后再看本篇~

另外相信伙伴们在研究react fiber架构时，都会看到`requestAnimationFrame`和`requestIdleCallback`，它们都与浏览器的帧息息相关。

## 帧和FPS

> 如果不了解Performance，可以看[这篇](https://developer.chrome.com/docs/devtools/evaluate-performance/?utm_source=devtools#get-started)官方的文章。

在Chrome浏览器中，打开devTools，有一个Performance标签，左上角有一个reload的按钮，点它录制页面加载的过程，等页面加载完点停止，然后浏览器就会分析并显示性能分析报告：

![FPS和帧](https://gitee.com/ahuang6027/blog-images/raw/master/images/devtool-performance-frames-fps.png)

上图中间位置有一行表示帧，可以点击查看每一帧的详情。这里我随便点了一个，可以看到它总时长18.79毫秒，FPS为53。另外也可以看到，在页面首次绘制(FP)之前，帧那一行是空的。

### 什么是帧

> 【❗注意】“什么是帧”这一小节，很多都是我自己的理解，很可能有误（因为我没找着官方文档==）。跪求大佬们指正！
>
> 还记得吗，在笔记[从进程&线程看-页面渲染流程](https://github.com/FE-Huang/StudyNotes/blob/master/6.%20FE%E7%9B%B8%E5%85%B3%26%E5%BB%B6%E7%94%B3/%E6%B5%8F%E8%A7%88%E5%99%A8/%E4%BB%8E%E8%BF%9B%E7%A8%8B%26%E7%BA%BF%E7%A8%8B%E7%9C%8B-%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.md)中：  
>
> - 合成帧：在图层栅格化后，合成线程会收集图块上叫绘画四边形(draw quads)的信息构建合成帧；
> - 渲染流水线：是指渲染进程从解析HTML文件到合成页面

**对帧跟合成帧的理解：**

- 合成帧是渲染流水线最后合成后得到的“结果”；
- 这里说的帧更像是一个“过程”，在这个过程中，各个线程互相配合协作，从事件触发到`requestIdleCallback`，其中包含了合成帧这个结果。（这个过程写在下文）

**另有一个我不确定的点：**

从上边的Performance分析图中看到，页面首次绘制(FP)之前，帧那一行是空的。是不是意味着页面在FP之前，是没有帧的呢？  
这是我自己的看法（❗很可能有误）：

- 首先我觉得对帧的理解上，别太局限自己。中文博大精深，听老师的话，咱也结合语境来理解帧这个字。如果说语境上它表示一个过程，就把它理解成过程；如果说表示要渲染的东西（即结果），那它就是合成帧。
- 其次在performance中，帧既是一个过程，其实也是一个结果。页面FP之前，浏览器连一个合成帧都没“造”出来，所以怎么可能有帧呢。
- 还有一种情况，加入DOM构建完毕但css还在下载，这种情况下渲染流水线无事可做，就也会有一个空闲时间。

### 什么是FPS

> 【❗注意】设备的屏幕刷新率和浏览器的FPS是两个概念。屏幕刷新率是我们的电脑屏幕每秒能够显示图像的次数，单位是`hz(赫兹)`。

- [FPS](https://developer.chrome.com/docs/devtools/evaluate-performance/?utm_source=devtools#analyze_frames_per_second)全称为**Frams Per Second**，即**每秒的帧数**，也就是**渲染流水线每秒更新的帧数**。网页上我们看到的各种各样的效果，都是一个帧一个帧渲染出来的。可以将一个帧理解成一个画面，FPS就是每秒画面更新的次数。如果咱们页面上有动画，FPS越大，动画就越流畅。这里摘抄[一位大佬](https://zhuanlan.zhihu.com/p/78569750)的数据：  
  - FPS能够达到`50 ～ 60`的动画将会相当流畅，让人倍感舒适；
  - FPS在`30 ～ 50`之间的动画，因各人敏感程度不同，舒适度因人而异；
  - FPS在`30`以下的动画，让人感觉到明显的卡顿和不适感；
  - FPS波动很大的动画，亦会使人感觉到卡顿。
- 浏览器的FPS受限于设备的屏幕刷新率，即**FPS的值小于等于设备刷新率的值**；
- 一般浏览器的FPS为60（因为大多数设备的屏幕刷新率是60hz），且浏览器的FPS不是恒定的（从上边的Performance图就可以看出）。

## 一帧里发生了什么

![浏览器的一帧](https://gitee.com/ahuang6027/blog-images/raw/master/images/process-one-frame.png)

### Vsync and input data

`Vsync and input data`可以理解成**输入事件**。从浏览器的角度来看，输入其实代表着来自用户的**任何手势动作(gesture)**，包括滚动页面、触碰屏幕、移动鼠标、点击页面等等。

#### 具体步骤

1. 用户做了手势动作（比如移动鼠标），`Browser进程`接收到这个事件；
   1. 【❗Tip】`Browser进程`是第一个接收到这些事件的地方。
2. `Browser进程`将事件的**类型(如touchstart)和坐标(coordinates)**发送给`Renderer进程`：`Browser进程`只能知道用户的手势动作发生在什么地方，而不知道如何处理（因为tab页内的内容是由页面的`Renderer进程`负责的），所以`Browser进程`会将事件的相关信息发给`Renderer进程`；
3. `Renderer进程`接收到事件的相关信息后，找到事件的目标对象(target)，再运行这个事件绑定的监听函数(listener)。

## 参考

- [Inside look at modern web browser (part 4)](https://developer.chrome.com/blog/inside-browser-part4)
- [一文看懂Chrome浏览器运行机制](https://zhuanlan.zhihu.com/p/102149546)
- [Rendering Performance](https://web.dev/rendering-performance/)
- [浏览器每一帧](https://github.com/hushicai/hushicai.github.io/issues/5)
- [浏览器渲染优化](https://github.com/hushicai/hushicai.github.io/issues/3)
- [前端性能优化--刷新率(FPS)](https://zhuanlan.zhihu.com/p/78569750)
- [走进React Fiber的世界](https://juejin.cn/post/6943896410987659277)
